<!DOCTYPE html>
<html>

<head>
  <title>Google OAuth</title>
  <style>
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
    }

    #createEventBtn {
      display: none; /* hidden until login success */
    }
  </style>
</head>

<body>
  <button id="signInBtn" onclick="window.api.openAuthUrl()">Sign In with Google</button>

  <button id="createEventBtn">Create Event</button>

  <script>
    let savedCreatedAt = null;

    window.api.startTokenWatcher(async (tokens) => {
      if (tokens && tokens.accessToken && tokens.idToken) {

        let userId = "Unknown";
        const payload = JSON.parse(atob(tokens.idToken.split(".")[1]));
        userId = payload.sub;

        if (!savedCreatedAt) {
          savedCreatedAt = new Date().toLocaleString();
        }

        const expiresAt = tokens.expiryDate
          ? new Date(tokens.expiryDate).toLocaleString()
          : "Unknown";

        // Store tokens in IndexedDB
        await window.api.saveToIndexedDB({
          id: "google-user",
          userId,
          refreshToken: tokens.refreshToken,
          accessToken: tokens.accessToken,
          createdAt: savedCreatedAt,
          expiresAt
        });

        document.getElementById("signInBtn").style.display = "none";
        document.getElementById("createEventBtn").style.display = "inline-block";
      }
    });
  </script>
</body>

</html>